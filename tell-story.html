<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazing Story</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Cinzel:wght@600;800&display=swap" rel="stylesheet">
    <style>
        /* Define color palette and typography */
        :root {
            --dark-bg: #1f2937;
            --container-bg: #374151;
            --success-color: #10b981;
            --error-color: #ef4444;
            --gold-color: #fca311;
            --myth-blue: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .title-font {
            font-family: 'Cinzel', serif;
        }

        /* Main container styling */
        .container {
            max-width: 1000px;
            width: 100%;
            background: linear-gradient(145deg, var(--container-bg), #1f2937);
            padding: 2rem 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.7);
        }

        /* Input highlight for ESL focus */
        .story-input:focus {
            box-shadow: 0 0 0 4px rgba(252, 163, 17, 0.4); /* Tailwind's amber-500 equivalent */
        }
        
        /* Story and Reaction Box Styling */
        .story-output-box {
            border: 2px solid var(--myth-blue);
        }
        .tree-reaction-box {
            border: 2px solid #34d399; /* Green-400 */
        }
        
        /* Utility for small screens */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900">

    <div class="container">
        <!-- ESL Storytelling Stage -->
        <div id="main-story-challenge" class="w-full">
            <h1 class="title-font text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 mb-2">
                üå≥ The Best Story Ever
            </h1>
            <p class="text-gray-300 text-lg mb-6">
                The **enchanted tree** demands an amazing story! Fill in the blanks to begin your story.
            </p>

            <!-- Input Fields Area -->
            <div id="madlibs-inputs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6 rounded-xl bg-gray-700 border border-gray-600">
                <!-- Inputs generated here by JS -->
            </div>
            
            <button id="generate-story-button" class="mt-8 px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-full text-lg shadow-lg shadow-green-500/50 transition-all duration-300 transform hover:scale-105" onclick="generateStoryPart1()">
                Tell Part 1 of the Epic
            </button>
            
            <!-- Story Output and Intermediate Message -->
            <div id="story-output" class="hidden mt-8 p-6 rounded-xl bg-gray-800 story-output-box">
                <h3 class="title-font text-3xl text-indigo-400 mb-4">Part 1: The Origin of Power</h3>
                <p id="story-text" class="text-lg leading-relaxed whitespace-pre-wrap"></p>
            </div>

            <!-- Intermediate Check Button (Appears after Part 1) -->
            <button id="check-tree-part1-button" class="hidden mt-8 px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full text-lg shadow-lg shadow-red-500/50 transition-all duration-300 transform hover:scale-105" onclick="checkTreePart1()">
                See if the tree is liking your story
            </button>
            
            <!-- Final Check Button (Appears after Part 2 is generated) -->
            <button id="check-tree-final-button" class="hidden mt-8 px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full text-lg shadow-lg shadow-indigo-500/50 transition-all duration-300 transform hover:scale-105" onclick="checkTreeFinal()">
                See if the tree liked your story
            </button>

            <!-- Tree Reaction / Final Key Output (STEP 2 RESULT) -->
            <div id="tree-reaction-output" class="hidden mt-8 p-6 rounded-xl bg-green-900 tree-reaction-box">
                <h3 class="title-font text-3xl text-green-400 mb-4">The Tree's Decision:</h3>
                <p id="tree-verdict-text" class="text-xl text-gray-100 mb-4"></p>
                <div class="mt-6 pt-4 border-t border-green-500">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for state management
        let properNounCount = 0;
        let storyPart1 = "";
        let currentStage = 1;
        let heroName = ""; // Stores the hero name for use in Part 2

        // --- DATA SETUP (MAD LIBS CHALLENGE) ---
        // Part 1 words - 5 words total
        const madlibsPart1 = [
            { id: 'properNoun1', label: '1. Proper Name (Person)', type: 'text', placeholder: 'e.g., Quentin Coldwater' },
            { id: 'adjective1', label: '2. Describing Word (Adjective)', type: 'text', placeholder: 'e.g., Strong' },
            { id: 'adjective2', label: '3. Describing Word (Adjective)', type: 'text', placeholder: 'e.g., Tiny' },
            { id: 'verb1', label: '4. Action Word (Verb)', type: 'text', placeholder: 'e.g., Climb' },
            { id: 'adverb1', label: '5. Action Word (-ly Adverb)', type: 'text', placeholder: 'e.g., Quickly' },
            { id: 'adjective3', label: '6. Describing Word (Clothing)', type: 'text', placeholder: 'e.g., Tight' },
            { id: 'properNoun2', label: '7. Proper Noun (Hero Name - title)', type: 'text', placeholder: 'e.g., The Rock' },
            { id: 'nounSingular1', label: '8. Noun (Event)', type: 'text', placeholder: 'e.g., Party' },
        ];
        
        // Part 2 words - 5 words total
        const madlibsPart2 = [
            { id: 'noun2', label: '9. Noun (Concept)', type: 'text', placeholder: 'e.g., Power' },
            { id: 'noun3', label: '10. Noun (Concept)', type: 'text', placeholder: 'e.g., Wealth' },
            { id: 'adjective4', label: '11. Describing Word (Feeling)', type: 'text', placeholder: 'e.g., Difficult' },
            { id: 'nounPlural1', label: '12. Noun (Plural, People)', type: 'text', placeholder: 'e.g., Dancers' },
            { id: 'nounPlural2', label: '13. Noun (Plural, People)', type: 'text', placeholder: 'e.g., Teachers' },
            { id: 'nounPlural3', label: '14. Noun (Plural, People)', type: 'text', placeholder: 'e.g., Strangers' },
            { id: 'verb2', label: '15. Action Word (Past Tense Verb)', type: 'text', placeholder: 'e.g., Ran' },
            { id: 'verb3', label: '16. Action Word (Present Tense Verb)', type: 'text', placeholder: 'e.g., Hurt' },
        ];

        // --- STORY TEMPLATES ---
        const storyTemplate1 = `
\${properNoun1} was an ordinary student who lived with their aunt and uncle in New York City. They loved science and tried to stay out of trouble. Most people didn‚Äôt notice them. They weren‚Äôt \${adjective1}, popular, or brave. They just wanted a quiet life.

One day, during a school trip, our hero was bitten by a \${adjective2} spider that had been part of an experiment. At first, they felt sick. Then strange things began to happen. They could \${verb1} walls, jump high, and move \${adverb1}.

At first, everything was fun. They built web-shooters that let them swing between buildings. They made a \${adjective3} costume and chose a name for themselves: ‚Äú\${properNoun2}.‚Äù They used their new powers to win a contest and earn some money.

One night, after coming home from a \${nounSingular1}, a thief ran past. A police officer shouted for help, but our hero did nothing. ‚ÄúNot my problem,‚Äù they said. A few hours later, they came home to police cars outside. Their uncle had been hurt during a robbery‚Äîit was the thief from before!
        `;

        const storyTemplate2 = `
<br><h3 class="title-font text-3xl text-indigo-400 mb-4">Part 2: The Final Confrontation</h3>
That moment changed everything. They remembered their uncle‚Äôs words: ‚ÄúWith great \${noun2} comes great \${noun3}.‚Äù They understood that real strength means helping others, even when it‚Äôs \${adjective4} or unfair.

From that day on, our hero used their powers to protect people. They stopped \${nounPlural1}, helped \${nounPlural2}, and rescued \${nounPlural3} from danger. 

Life as a hero was never easy, but our hero never quit. Whenever they saw someone in trouble, they \${verb2}. Because they knew that if they didn‚Äôt, someone else might get \${verb3}.
        `;

        document.addEventListener('DOMContentLoaded', () => {
            // Start by initializing Part 1 inputs
            initializeInputs(madlibsPart1);
        });

        // Helper function to generate inputs
        function initializeInputs(parts) {
            const inputsContainer = document.getElementById('madlibs-inputs');
            inputsContainer.innerHTML = ''; // Clear existing inputs
            parts.forEach(part => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col space-y-1';
                
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-300';
                label.textContent = part.label;

                const input = document.createElement('input');
                input.id = part.id;
                input.type = part.type;
                input.placeholder = part.placeholder;
                input.className = 'story-input w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-amber-500';
                
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                inputsContainer.appendChild(wrapper);
            });
            // Update prompt based on stage
            document.querySelector('p.text-gray-300').textContent = `The ancient, enchanted tree demands a heroic origin story in two parts! Fill in the blanks to satisfy its mighty spirit. (Part ${currentStage} of 2)`;
        }

        // Helper function to check inputs and replace placeholders
        function processInputs(parts, template) {
            let story = template;
            let missingInputs = false;
            
            // Collect and check inputs
            parts.forEach(part => {
                const inputElement = document.getElementById(part.id);
                // Check if the element exists before trying to read its value 
                if (!inputElement) {
                    return; 
                }

                const value = inputElement.value.trim();
                
                if (value === "") {
                    missingInputs = true;
                    inputElement.classList.add('border-red-500', 'ring-2', 'ring-red-500'); 
                } else {
                    inputElement.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                    
                    // Replace placeholder
                    // Note: properNoun1 and properNoun2 are treated as "Hero Name" and "Hero Name - title" in Part 1 inputs
                    // and will be replaced correctly in the template.
                    const regex = new RegExp(`\\\$\\{${part.id}\\}`, 'g');
                    story = story.replace(regex, `<span class="font-extrabold text-yellow-300">${value}</span>`);
                }
            });
            return { story, missingInputs };
        }


        // --- STEP 1: GENERATE STORY PART 1 ---
        function generateStoryPart1() {
            const storyOutput = document.getElementById('story-output');
            const storyTextElement = document.getElementById('story-text');
            const checkTreePart1Button = document.getElementById('check-tree-part1-button');
            const generateButton = document.getElementById('generate-story-button');

            // Process inputs (no final key counting yet)
            const { story, missingInputs } = processInputs(madlibsPart1, storyTemplate1);
            
            if (missingInputs) {
                showMessage('Please fill in all the blanks for Part 1!', 'error');
                storyOutput.classList.add('hidden');
                checkTreePart1Button.classList.add('hidden');
                return;
            }

            // Save the hero name (properNoun1) and story part *before* the inputs are cleared for Part 2
            // We use properNoun1 to be consistent with the template's repeated use of the hero's name.
            heroName = document.getElementById('properNoun1').value.trim();
            storyPart1 = story; 

            storyTextElement.innerHTML = storyPart1;
            storyOutput.classList.remove('hidden');
            checkTreePart1Button.classList.remove('hidden');
            
            // Disable inputs and button for Part 1
            document.querySelectorAll('#madlibs-inputs input').forEach(input => { input.disabled = true; });
            generateButton.disabled = true;

            showMessage('Part 1 is ready! Present it to the Tree.', 'success');
        }

        // --- INTERMEDIATE CHECK: TREE IS INTERESTED ---
        function checkTreePart1() {
            const checkTreePart1Button = document.getElementById('check-tree-part1-button');
            const generateButton = document.getElementById('generate-story-button');

            // 1. Give positive feedback
            showMessage('The tree seems very interested and asks you to continue! Fill in the new blanks above', 'success');
            
            // 2. Advance stage
            currentStage = 2;
            properNounCount = 0; 

            // 3. Clear and Load Part 2 inputs
            initializeInputs(madlibsPart2);

            // 4. Update button for Part 2
            generateButton.textContent = 'Tell the Conclusion';
            generateButton.onclick = generateStoryPart2;
            generateButton.disabled = false;
            
            // 5. Hide intermediate button
            checkTreePart1Button.classList.add('hidden');
            
            // Clear previous message box output
            document.getElementById('tree-reaction-output').classList.add('hidden');
        }

        // --- STEP 2: GENERATE STORY PART 2 (Conclusion) ---
        function generateStoryPart2() {
            const storyTextElement = document.getElementById('story-text');
            const checkTreeFinalButton = document.getElementById('check-tree-final-button');

            // 1. Process words for Part 2 
            const { story: storyPart2, missingInputs } = processInputs(madlibsPart2, storyTemplate2);

            if (missingInputs) {
                showMessage('Please fill in all the blanks for Part 2!', 'error');
                checkTreeFinalButton.classList.add('hidden');
                return;
            }
            
            // 2. Combine stories. We use the globally saved 'heroName' variable to replace the placeholder
            // in the Part 2 text that requires the properNoun1 (Hero Name) placeholder.
            const part2WithHeroName = storyPart2.replace(
                /\$\{\s*properNoun1\s*\}/g, 
                `<span class="font-extrabold text-yellow-300">${heroName}</span>`
            );

            const finalStory = storyPart1 + part2WithHeroName;
            
            storyTextElement.innerHTML = finalStory;

            // 3. Lock inputs and show final check button
            document.querySelectorAll('#madlibs-inputs input').forEach(input => { input.disabled = true; });
            document.getElementById('generate-story-button').disabled = true;
            checkTreeFinalButton.classList.remove('hidden');
            
            showMessage('The Epic is complete! Present the grand finale to the Tree.', 'success');
        }


        // --- FINAL CHECK: TREE'S VERDICT ---
        function checkTreeFinal() {
            const treeReactionOutput = document.getElementById('tree-reaction-output');
            const finalKeyDisplay = document.getElementById('final-key-display');
            const treeVerdictText = document.getElementById('tree-verdict-text');
            const checkTreeFinalButton = document.getElementById('check-tree-final-button');

            // The key is based on the two user-provided proper nouns (Person's Name and Hero Name/Title).
            const finalKey = 2; 

            // Set the success narrative and final key
            treeVerdictText.innerHTML = `The enchanted tree glowed with satisfaction! "An inspiring origin story! You have proven your worth and may leave my sight."`;
            finalKeyDisplay.textContent = finalKey; 

            // 3. Reveal the final section and disable the button
            treeReactionOutput.classList.remove('hidden');
            checkTreeFinalButton.disabled = true;
            
            // Final instruction to the students
            const finalInstruction = document.createElement('p');
            finalInstruction.className = 'text-2xl text-red-300 font-bold mt-4';
            finalInstruction.textContent = "Now, use this key and GO BACK TO THE LABYRINTH PAGE to proceed!";
            treeReactionOutput.appendChild(finalInstruction);

            showMessage(`Success! The Tree has given you the final key: ${finalKey}`, 'success');
        }


        /**
         * Shows a message box for feedback (replacing alert/confirm).
         * @param {string} message The message to display.
         * @param {string} type The type of message ('success' or 'error').
         */
        function showMessage(message, type = 'error') {
            const msgBox = document.createElement('div');
            msgBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 transition-all duration-300 rounded-xl shadow-2xl text-center font-semibold max-w-sm w-full';
            msgBox.textContent = message;

            if (type === 'success') {
                msgBox.classList.add('bg-green-600', 'text-white');
            } else {
                msgBox.classList.add('bg-red-600', 'text-white');
            }
            
            document.body.appendChild(msgBox);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                msgBox.classList.add('opacity-0');
                msgBox.addEventListener('transitionend', () => msgBox.remove());
            }, 3000);
        }

        // Expose functions globally for button clicks
        window.generateStoryPart1 = generateStoryPart1;
        window.generateStoryPart2 = generateStoryPart2;
        window.checkTreePart1 = checkTreePart1;
        window.checkTreeFinal = checkTreeFinal;
    </script>

</body>
</html>
